% FREQ_SWEEP.M
% The following script produces a plot of the analytical solution versus
% numerically simulated for a fixed discretization. Two plots are produced,
% One for L0, DeltaL (half-space) and DeltaL(sandwich), and one for DeltaR
% and DeltaR.


clear all
addpath([pwd '/test_fdm'])
%% Setup the frequencies and geometries to be swept
w = logspace(2,6,10);
RECALC_G = 0;

% Generate Filaments
NUM_ELE = 300; % Number of elements simulated
WID = 1e-6;
HEI = 1e-6;
D = 4e-3;
RAD = 0.1;%linspace(2.5e-2,10.5e-2,23);

% Generate circular filaments
path = genSpiralPath(RAD, -(D+HEI/2), NUM_ELE);
fils = genFilsFromPath(path,WID,HEI);
%
%showFils(O,L,W,H);
I = ones(size(fils{1},1),1);

%% Setup the Green's functions

try 
    obj = load('g_swept','w');
catch
    obj = struct('w',[]);
end

if RECALC_G || isequal(obj.w,w) % Manual override or if w has changed
%-------------------------------------------------------------------------
% The following is the time-consuming evaluation of Green's functions.
% Perform once!
g_hs = sweep_tph(w,1); % Use defaultL(1).
g_fl = sweep_tph(w,5); % Use defaultL(5).
save('g_swept','g_hs','g_fl','w');
%-------------------------------------------------------------------------
end

%% Calculate the Free-space component
% Setup the kernel
induct(max(RAD)*1.2,[-0.01 -0.002]);
Vfree = sum(induct(I,fils{:}));
Vfreea = analySqRing(RAD,WID);
(Vfree-Vfreea)/Vfreea

%% Iterate through each frequency
Vsub = zeros(length(w),1); % impedance calculated
Vsuba = zeros(length(w),1); % impedance analytical

for ii = 1:length(w)
    % pfft solution
    induct(max(RAD)*1.2,[-0.010 -0.002],g_hs{ii},true);
    Vsub(ii) = sum(induct(I,fils{:}));
    
    
    % analytic solution
    thisL = defaultL(1); thisL.w = w(ii);
    Vsuba(ii) = analy_sol_coil(RAD,D,thisL);
end
Vsub
Vsuba
save('new_pfft','w','Vsub','Vfree','Vsuba');

%%

%load new_pfft;
% Get the L and R
L_c = real(Vsub);
L_a = real(Vsuba);
L_e = abs(L_c-L_a);
R_c = -imag(Vsub).*w(:);
R_a = -imag(Vsuba).*w(:);

figure(1)
myplot(gca,w,L_c,w,L_a);
set(gca,'XScale','log')
xlim('auto')
ylabel('\DeltaL [H]');
xlabel('w [rads^{-1}]');
legend('This work','Analy. sol.');
grid on

figure(2)
myplot(gca,w,R_c,w,R_a);
set(gca,'XScale','log')
set(gca,'YScale','log')
xlim('auto')
ylabel('\DeltaR [H]');
xlabel('w [rads^{-1}]');
legend('This work','Analy. sol.');
grid on